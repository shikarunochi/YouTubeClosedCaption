<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />

  <script>
    function startVideo() {
      videoId = document.getElementById("videoId").value;
      if (videoId == "") {
        window.alert("Input VideoId");
        return;
      }
      getSrt(videoId);
      player = new YT.Player('player', {
        height: '360',
        width: '640',
        videoId: videoId, //'eP9y_7it3ZM',
        startSeconds: 0,
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerReady(event) {
      event.target.seekTo(0);
      event.target.playVideo();
      setTimeout(updatePosition, 1000);
    }

    var done = false;
    function onPlayerStateChange(event) {
      //if (event.data == YT.PlayerState.PLAYING && !done) {
      //  setTimeout(stopVideo, 6000);
      //  done = true;
      //}
    }

    function stopVideo() {
      player.stopVideo();
    }

    function curTime() {
      window.alert(player.getCurrentTime());
    }

    var srtTimes = [];

    function getSrt(videoId) {
      //https://video.google.com/timedtext?hl=en&lang=en&name=&v=eP9y_7it3ZM
      //https://css-tricks.com/how-to-fetch-and-parse-rss-feeds-in-javascript/
      fetch("https://video.google.com/timedtext?hl=en&lang=en&name=&v=" + videoId)
        .then(response => response.text())
        .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
        .then(data => {
          //console.log(data);
          const textList = data.querySelectorAll("text")
          let html = ``
          let index = 0;
          textList.forEach(element => {
            html += `
          <p id="${index}" onclick="jumpTo(${index});">
          ${element.innerHTML}
          </p>
          `
            srtTimes.push(0 + element.getAttribute("start")); //数値として
            index++;
          });
          //document.body.insertAdjacentHTML("beforeend", html);
          var srtList = document.getElementById('srtList');
          srtList.innerHTML = html

          //console.log(srtTimes);
        });
    }
    //https://webmanab-html.com/tip/scroll-box-animation/
    var preTarget = 0;


    function selectSrt(index) {
      document.getElementById(preTarget).style.color = "";
      var srtList = document.getElementById('srtList');
      var targetSrt = document.getElementById(index);
      var position = targetSrt.offsetTop - srtList.offsetTop - srtList.clientHeight / 2; //全体の中心あたりにもってくる。
      //console.log("position:" + position);
      if (position < 0) {
        position = 0;
      }
      //もし現在の位置が、画面外なら、ユーザがスクロール操作中なので位置は変更しない。
      if(Math.abs(srtList.scrollTop - position) < srtList.clientHeight / 2 )
      {
        srtList.scrollTop = position;
      }
      //location.hash = index;
      targetSrt.style.color = "red";

      preTarget = index;
    }

    var updatePosition = function () {
      //現在の再生時間を取得、それに一番近いインデックスまでジャンプ
      curTime = player.getCurrentTime();
      index = 0;
      for (index = 0; index < srtTimes.length; index++) {
        if (curTime < srtTimes[index]) {
          break;
        }
      }
      if (index > 0) {
        index = index - 1;
      }
      selectSrt(index);
      setTimeout(updatePosition, 500);
    }

    function jumpTo(index){
      player.seekTo(srtTimes[index]);
    }
  </script>

</head>

<body>

  <input type="text" id="videoId" placeholder="VideoId">
  <input type="button" value="StartVideo" onClick='startVideo();'>
  <hr/>
  <!-- //https://developers.google.com/youtube/iframe_api_reference?hl=ja-->
  <div id="player"></div>


  <script>
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player;
  </script>

  <div id="srtList" style="width:100%;height:500px;overflow:auto;">
  </div>

</body>

</html>